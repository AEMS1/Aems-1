<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูพุดโูุฑูุด ุชูฺฉู | ุฏุงุดุจูุฑุฏ ุญุฑููโุง</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
  <!-- Ethers (ุจุฑุง ุงุชุตุงู ฺฉู ูพูู ูุงูุน) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- Chart.js ุจุฑุง ุชูฺฉูููฺฉุณ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{ --bg:#0b1020; --card:#111735; --muted:#9aa4bf; --brand:#22d3ee; --brand2:#3b82f6; }
    body{ background:radial-gradient(80rem 40rem at 80% -10%,rgba(59,130,246,.15),transparent),
                     radial-gradient(60rem 30rem at -10% -20%,rgba(34,211,238,.18),transparent),
                     var(--bg); color:#e6e9f5; font-family:"Vazirmatn", system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .card{ background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius:1.25rem; box-shadow:0 10px 40px rgba(0,0,0,.45); }
    .btn{ background:linear-gradient(90deg,var(--brand),var(--brand2)); border-radius:1rem; padding:.9rem 1.2rem; font-weight:800; color:white; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .soft{ color:var(--muted); }
    .kbd{ background:#0b122b; border:1px solid rgba(255,255,255,.08); border-radius:.5rem; padding:.2rem .45rem; font-size:.9rem; }
    .progress{ height:.625rem; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; }
    .progress > span{ display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand2)); }
  </style>
</head>
<body>
  <!-- ูุฏุฑ -->
  <header class="sticky top-0 z-40 backdrop-blur bg-black/25 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400 to-blue-500"></div>
        <div>
          <h1 id="projectName" class="text-xl font-extrabold">ูุงู ูพุฑูฺู</h1>
          <p id="tokenTicker" class="text-xs soft">ููุงุฏ: MTK</p>
        </div>
      </div>
      <div class="ms-auto flex items-center gap-3">
        <span id="networkBadge" class="text-xs soft hidden md:inline"></span>
        <button id="btnConnect" class="btn">ุงุชุตุงู ฺฉู ูพูู</button>
      </div>
    </div>
  </header>

  <!-- ุณฺฉุดู ูุนุฑู -->
  <section class="max-w-7xl mx-auto px-4 pt-10 grid md:grid-cols-2 gap-8 items-center">
    <div>
      <h2 class="text-3xl md:text-5xl font-extrabold leading-[1.15]">ูพุดโูุฑูุด ุฑุณู <span id="heroToken" class="text-cyan-300">MTK</span></h2>
      <p id="projectPitch" class="soft mt-4">ุฏุฑ ูพุดโูุฑูุด ฺูุฏูุฑุญููโุง ูุง ุจุง ููุชโูุง ูพูฺฉุงู ุดุฑฺฉุช ฺฉูุฏ. ุชูุงู ุฏุงุฏูโูุง ูุณุชููุงู ุงุฒ ูุฑุงุฑุฏุงุฏ ุฎูุงูุฏู ุฎูุงูุฏ ุดุฏ. ูพุณ ุงุฒ ูพุงุงูุ ฑตูช ุขุฒุงุฏุณุงุฒ (TGE)ุ ุณูพุณ ถ ูุงู ฺฉูู ู ุจุนุฏ ุขุฒุงุฏุณุงุฒ ูุงูุงูู ุจุงูโูุงูุฏู.</p>
      <div class="mt-6 flex gap-3">
        <a href="#buy" class="btn">ุฎุฑุฏ ุชูฺฉู</a>
        <a href="#stages" class="px-4 py-3 rounded-xl border border-white/15">ูุดุงูุฏู ูุฑุงุญู</a>
      </div>
      <div class="mt-6 text-sm soft">ฺฉู ูุฏู ุฌุฐุจ ุณุฑูุงู: <span id="goalUSD" class="font-bold text-white"></span>
        ยท ฺฉู ุชูฺฉูโูุง ูพุดโูุฑูุด: <span id="goalTKN" class="font-bold text-white"></span>
      </div>
    </div>
    <div class="card p-6">
      <h3 class="font-extrabold text-xl mb-4">ูุถุนุช ูุญุธูโุง ูพุดโูุฑูุด</h3>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div class="p-4 rounded-xl bg-white/5">
          <div class="soft">ูุฑุญูู ูุนู</div>
          <div class="text-2xl font-extrabold" id="currentStageLabel">โ</div>
        </div>
        <div class="p-4 rounded-xl bg-white/5">
          <div class="soft">ููุช ูุนู</div>
          <div class="text-2xl font-extrabold"><span id="currentPrice">โ</span> <span class="text-base">USD</span></div>
        </div>
        <div class="col-span-2 p-4 rounded-xl bg-white/5">
          <div class="soft mb-2">ูพุดุฑูุช ูุฑุญูู</div>
          <div class="progress"><span id="stageProgress" style="width:0%"></span></div>
          <div class="flex justify-between text-xs soft mt-1"><span>ูุฑูุฎุชูโุดุฏู: <span id="soldInStage">0</span></span><span>ุจุงูโูุงูุฏู: <span id="leftInStage">0</span></span></div>
        </div>
        <div class="col-span-2 p-4 rounded-xl bg-white/5">
          <div class="soft mb-1">ุณุฑูุงู ุฌุฐุจโุดุฏู ฺฉู</div>
          <div class="progress"><span id="totalProgress" style="width:0%"></span></div>
          <div class="flex justify-between text-xs soft mt-1"><span>USD ุฌูุนโุดุฏู: <span id="raisedUSD">0</span></span><span>ูุฏู: <span id="goalUSD2">0</span></span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ุฌุฏูู ูุฑุงุญู -->
  <section id="stages" class="max-w-7xl mx-auto px-4 pt-12">
    <div class="flex items-end justify-between mb-4">
      <h3 class="text-2xl md:text-3xl font-extrabold">ูุฑุงุญู ูพุดโูุฑูุด</h3>
      <span class="soft text-sm">* ุจุง ุงุชูุงู ููุฌูุฏ ูุฑ ูุฑุญููุ ูุฑุญูู ุจุนุฏ ูุนุงู ูโุดูุฏ</span>
    </div>
    <div class="overflow-x-auto card p-0">
      <table class="min-w-full">
        <thead class="bg-white/10 text-sm">
          <tr>
            <th class="text-right p-3">#</th>
            <th class="text-right p-3">ููุช (USD)</th>
            <th class="text-right p-3">ุชูฺฉู ุงู ูุฑุญูู</th>
            <th class="text-right p-3">ูุฑูุฎุชูโุดุฏู</th>
            <th class="text-right p-3">ุจุงูโูุงูุฏู</th>
            <th class="text-right p-3">ุณุฑูุงู (USD)</th>
          </tr>
        </thead>
        <tbody id="stageRows" class="text-sm"></tbody>
      </table>
    </div>
  </section>

  <!-- ุฎุฑุฏ -->
  <section id="buy" class="max-w-7xl mx-auto px-4 pt-12 grid md:grid-cols-2 gap-8 items-start">
    <div class="card p-6">
      <h3 class="font-extrabold text-xl mb-1">ุฎุฑุฏ ุชูฺฉู</h3>
      <p class="soft mb-4 text-sm">ูพุฑุฏุงุฎุช ุจุง USDT ุง BNB. ููุฏุงุฑ ุฏูุงุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏุ ุณุณุชู ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุจู ูุฑุงุญู ุชูุณู ูโฺฉูุฏ.</p>

      <label class="block text-sm mb-1">ุงุฑุฒ ูพุฑุฏุงุฎุช</label>
      <div class="flex gap-2 mb-4">
        <button data-pay="USDT" class="pay btn" aria-pressed="true">USDT</button>
        <button data-pay="BNB" class="pay px-4 py-3 rounded-xl border border-white/15">BNB</button>
      </div>

      <label class="block text-sm mb-1">ูุจูุบ ูพุฑุฏุงุฎุช (USD)</label>
      <input id="inpUsd" type="number" min="1" step="1" placeholder="ูุซูุงู 1000" class="w-full bg-black/30 border border-white/10 rounded-xl p-3 mb-3 focus:outline-none focus:ring-2 focus:ring-cyan-400" />

      <div class="text-xs soft mb-3">ุฏุฑุงูุช ุชูุฑุจ: <span id="estTokens" class="text-white font-bold">0</span> MTK</div>

      <button id="btnBuy" class="btn w-full">ุฎุฑุฏ</button>
      <div id="buyMsg" class="soft text-sm mt-3"></div>

      <div class="mt-4 text-xs soft">โ๏ธ ูพุณ ุงุฒ ุงุชุตุงู ูุฑุงุฑุฏุงุฏ ูุงูุนุ ุงู ุฏฺฉูู ุชุฑุงฺฉูุด ุฑู ุดุจฺฉู ุฑุง ุงุฌุฑุง ูโฺฉูุฏ. ุฏุฑ ุญุงู ุญุงุถุฑ ุญุงูุช ุฏูู ูุญุงุณุจุงุช ูุนุงู ุงุณุช.</div>
    </div>

    <!-- ุฏุงุดุจูุฑุฏ ฺฉุงุฑุจุฑ / ูููโฺฏุฐุงุฑ -->
    <div class="card p-6">
      <h3 class="font-extrabold text-xl mb-1">ุฏุงุดุจูุฑุฏ ุดูุง</h3>
      <p class="soft text-sm mb-4">ููุงุด ูุถุนุช ุขุฒุงุฏุณุงุฒ ูพุณ ุงุฒ ูพุงุงู ูพุดโูุฑูุด</p>

      <div class="grid grid-cols-2 gap-4 text-sm">
        <div class="p-4 rounded-xl bg-white/5"><div class="soft">ฺฉู ุฎุฑุฏ ุดูุง</div><div class="text-2xl font-extrabold" id="youTotal">0</div></div>
        <div class="p-4 rounded-xl bg-white/5"><div class="soft">ุขุฒุงุฏ ุดุฏู</div><div class="text-2xl font-extrabold" id="youUnlocked">0</div></div>
        <div class="p-4 rounded-xl bg-white/5"><div class="soft">ููู ุดุฏู</div><div class="text-2xl font-extrabold" id="youLocked">0</div></div>
        <div class="p-4 rounded-xl bg-white/5"><div class="soft">ูุงุจู Claim ุงฺฉููู</div><div class="text-2xl font-extrabold" id="youClaimable">0</div></div>
      </div>

      <div class="mt-4">
        <div class="soft text-xs mb-1">ุฒูุงู ุขุฒุงุฏุณุงุฒ ุจุนุฏ</div>
        <div class="p-3 rounded-xl bg-white/5 text-sm flex items-center gap-3">
          <span class="kbd" id="nextReleaseLabel">โ</span>
          <span class="soft" id="countdown">โ</span>
        </div>
      </div>

      <button id="btnClaim" class="btn w-full mt-4" disabled>Claim ุชูฺฉู</button>
      <div id="claimMsg" class="soft text-sm mt-3"></div>

      <div class="mt-4 text-xs soft">ุงูฺฏู ููู: <b>ฑตูช TGE</b> ยท <b>ถ ูุงู ฺฉูู</b> ยท ุณูพุณ ุขุฒุงุฏุณุงุฒ ูุงูุงูู <b>ฑด.ฑถถทูช</b> ุงุฒ ฺฉู ุชุง ุชฺฉูู.</div>
    </div>
  </section>

  <!-- Tokenomics -->
  <section id="tokenomics" class="max-w-7xl mx-auto px-4 pt-14">
    <h3 class="text-2xl md:text-3xl font-extrabold mb-4">ุชูฺฉูููฺฉุณ</h3>
    <div class="grid lg:grid-cols-3 gap-8">
      <div class="card p-6">
        <canvas id="pie"></canvas>
      </div>
      <div class="lg:col-span-2 card p-6">
        <div id="tokenomicsList" class="grid sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
        <div class="soft text-xs mt-4">ุจุฑุง ูุฑุงุด ุฏุฑุตุฏูุง ุจู ุดุก <span class="kbd">TOKENOMICS</span> ุฏุฑ ฺฉุฏ ูุฑุงุฌุนู ฺฉูุฏ.</div>
      </div>
    </div>
  </section>

  <!-- Roadmap -->
  <section id="roadmap" class="max-w-7xl mx-auto px-4 pt-14">
    <h3 class="text-2xl md:text-3xl font-extrabold mb-4">ููุดู ุฑุงู</h3>
    <div class="card p-6">
      <ol class="relative border-s border-white/10 ps-6 space-y-6">
        <li><span class="absolute -start-3 top-1.5 w-2 h-2 rounded-full bg-cyan-400"></span> ุดุฑูุน ูพุดโูุฑูุดุ ุงูุชุดุงุฑ ูุจโุณุงุช ู ูุงุชโูพูพุฑ</li>
        <li><span class="absolute -start-3 top-1.5 w-2 h-2 rounded-full bg-cyan-400"></span> ูพุงุงู ูพุดโูุฑูุดุ ุดุฑูุน TGE ู ุขูุงุฏูโุณุงุฒ ูุณุช ุฏุฑ DEX</li>
        <li><span class="absolute -start-3 top-1.5 w-2 h-2 rounded-full bg-cyan-400"></span> ุงูุฒูุฏู ููุฏูฺฏุ ููู LP ู ุดุฑูุน ฺฉูู ถูุงูู</li>
        <li><span class="absolute -start-3 top-1.5 w-2 h-2 rounded-full bg-cyan-400"></span> ุขุบุงุฒ ุขุฒุงุฏุณุงุฒ ูุงูุงูู ู ุชูุณุนู ุงฺฉูุณุณุชู</li>
      </ol>
    </div>
  </section>

  <!-- ููุชุฑ -->
  <footer class="max-w-7xl mx-auto px-4 py-12 soft text-sm">
    <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
      <div>ยฉ <span id="year"></span> <span id="brand">YourToken</span> โ ููู ุญููู ูุญููุธ ุงุณุช.</div>
      <div class="flex gap-4">
        <a class="underline" href="#">ุชูฺฏุฑุงู</a>
        <a class="underline" href="#">X (ุชูุชุฑ)</a>
        <a class="underline" href="#">ุฏุณฺฉูุฑุฏ</a>
        <a class="underline" href="#">ูุงุชโูพูพุฑ</a>
      </div>
    </div>
  </footer>

  <script>
  // =====================
  // โ๏ธ ูพฺฉุฑุจูุฏ ูุงุจูโูุฑุงุด
  // =====================
  const CONFIG = {
    projectName: "YourToken",
    symbol: "MTK",
    decimals: 18,
    // ุดุจฺฉู ุงุตู BSC = 56 ุ ุชุณุช ูุช = 97
    network: { chainId: 56, name: "BSC Mainnet" },
    // ูุฏู ุฌุฐุจ ุณุฑูุงู (ุจุฑุง ููุงุฑ ูพุดุฑูุช ฺฉู)
    goalUSD: 8_000_000,
    // ฺฉู ุชูฺฉูโูุง ูพุดโูุฑูุด
    totalPresaleTokens: 26_000_000,
    // ููุช ูุณุช ูุฏู (ุจุฑุง ููุงุด)
    targetListingUSD: 0.45,
    // ุชูุธูุงุช ูููโฺฏุฐุงุฑ
    vesting: {
      tgeUnlockPct: 0.15,     // 15%
      cliffMonths: 6,         // 6 ูุงู
      postCliffMonths: 6,     // 6 ูุณุท
      postCliffMonthlyPctOfTotal: 0.85/6 // = 0.141666...
    },
    // ุชุงุฑุฎ ูพุงุงู ูพุดโูุฑูุด (ูพุณ ุงุฒ ุงุชุตุงู ูุฑุงุฑุฏุงุฏ ุงุฒ ุฎูุฏ ูุฑุงุฑุฏุงุฏ ุฎูุงูุฏู ูโุดูุฏ)
    // ุจุฑุง ุฏูู ุชุงูุฑุ ุชุงุฑุฎ ููููู ุณุช ูโฺฉูู
    presaleEndAt: null, // ุจุง ุฏฺฉูู ูพุงุงู ุดุจูโุณุงุฒ ูโฺฉูู
    // ุขุฏุฑุณโูุง (ุจุนุฏุงู ููุฏุงุฑุฏู ฺฉู)
    addresses: {
      PRESALE_CONTRACT: "",   // โ ุจุนุฏ ุงุฒ ุขูุงุฏูโุดุฏู ูุฑุงุฑุฏุงุฏ ูุงุฑุฏ ฺฉู
      USDT: "",               // โ ุขุฏุฑุณ USDT ุฑู ุดุจฺฉู ุงูุชุฎุงุจ
    }
  };

  // ูุฑุงุญู (ธ+ฑ ุจูููุณ) โ ุฌูุนุงู 26,000,000 ุชูฺฉู ู โ 8,004,000$
  const STAGES = [
    { id:1, price:0.15, tokens:4_000_000, sold:0 },
    { id:2, price:0.20, tokens:3_800_000, sold:0 },
    { id:3, price:0.25, tokens:3_600_000, sold:0 },
    { id:4, price:0.28, tokens:3_400_000, sold:0 },
    { id:5, price:0.32, tokens:3_200_000, sold:0 },
    { id:6, price:0.34, tokens:3_000_000, sold:0 },
    { id:7, price:0.36, tokens:2_800_000, sold:0 },
    { id:8, price:0.40, tokens:2_200_000, sold:0 },
    { id:9, price:0.43, tokens:2_000_000, sold:0 } // Bonus Stage
  ];

  // ุชูฺฉูููฺฉุณ (ูุงุจู ูุฑุงุด)
  const TOKENOMICS = [
    { label:"ูพุดโูุฑูุด", value:26 },
    { label:"ููุฏูฺฏ", value:40 },
    { label:"ุชู", value:10 },
    { label:"ุจุงุฒุงุฑุงุจ", value:12 },
    { label:"ุงุฑุฏุฑุงูพ", value:5 },
    { label:"ุฐุฎุฑู", value:7 },
  ];

  // =====================
  // ๐ง ูุถุนุช ุจุฑูุงูู (Front Demo)
  // =====================
  let provider, signer, user;
  let payAsset = "USDT"; // ุง "BNB"

  // ุจุฑุง ุฏูู ุฎุฑุฏุ ุฏุงุฏูโูุง ฺฉุงุฑุจุฑ ุฑุง ุฏุฑ localStorage ูฺฏู ูโุฏุงุฑู
  const LS_KEY = "presale_demo";
  const state = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
  if(!state.purchases){ state.purchases = {}; }
  if(!state.raisedUSD){ state.raisedUSD = 0; }
  if(!state.presaleEndedAt){ state.presaleEndedAt = null; }

  // =====================
  // ๐งฉ ฺฉูฺฉโุชุงุจุนโูุง
  // =====================
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>document.querySelectorAll(sel);
  const fmt = (n)=>Number(n).toLocaleString("fa-IR");
  const now = ()=> new Date();

  function currentStageIndex(){
    for(let i=0;i<STAGES.length;i++){
      if(STAGES[i].sold < STAGES[i].tokens) return i;
    }
    return STAGES.length-1; // ุงฺฏุฑ ููู ูพุฑ ุดุฏ ุขุฎุฑู ุฑุง ุจุฑฺฏุฑุฏุงู
  }

  function calcEstTokens(usd){
    let remaining = usd;
    let tokens = 0;
    for(const s of STAGES){
      const left = s.tokens - s.sold;
      if(left <= 0) continue;
      const maxUsdInStage = left * s.price;
      const takeUsd = Math.min(remaining, maxUsdInStage);
      tokens += takeUsd / s.price;
      remaining -= takeUsd;
      if(remaining <= 0) break;
    }
    return tokens;
  }

  function buySimulate(usd, address){
    let remaining = usd;
    for(const s of STAGES){
      const left = s.tokens - s.sold;
      if(left <= 0) continue;
      const maxUsdInStage = left * s.price;
      const takeUsd = Math.min(remaining, maxUsdInStage);
      const takeTokens = takeUsd / s.price;
      s.sold += takeTokens;
      state.raisedUSD += takeUsd;
      remaining -= takeUsd;
      if(remaining <= 0) break;
    }
    state.purchases[address] = (state.purchases[address]||0) + (usd - remaining)/STAGES[currentStageIndex()].price; // ูุฒุฏฺฉโุณุงุฒ
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function calcUserVesting(address){
    const total = Number(state.purchases[address]||0);
    if(!total) return { total:0, unlocked:0, claimable:0, nextRelease:null };

    // ุงฺฏุฑ presaleEndAt ุชุนู ูุดุฏู
    const endAt = state.presaleEndedAt ? new Date(state.presaleEndedAt) : null;
    if(!endAt){ return { total, unlocked:0, claimable:0, nextRelease:null } }

    const v = CONFIG.vesting;
    const tge = v.tgeUnlockPct * total; // 15%

    const cliffEnd = new Date(endAt);
    cliffEnd.setMonth(cliffEnd.getMonth() + v.cliffMonths);

    const monthly = v.postCliffMonthlyPctOfTotal * total; // โ14.1667% ฺฉู

    let unlocked = 0;
    const nowTs = now();

    if(nowTs >= endAt){ unlocked += tge; }

    if(nowTs >= cliffEnd){
      // ฺูุฏ ูุงู ุจุนุฏ ุงุฒ ฺฉูู ฺฏุฐุดุชูุ
      let months = (nowTs.getFullYear()-cliffEnd.getFullYear())*12 + (nowTs.getMonth()-cliffEnd.getMonth());
      // ุงฺฏุฑ ุฑูุฒ ูุงู ุฌุงุฑ ูููุฒ ูฺฏุฐุดุชู ุจุงุดุฏุ ฺฉ ูุงู ฺฉู ฺฉู
      if(nowTs.getDate() < cliffEnd.getDate()) months -= 1;
      months = Math.max(0, Math.min(months+1, CONFIG.vesting.postCliffMonths));
      unlocked += months * monthly;
    }

    unlocked = Math.min(unlocked, total);

    // ูุญุงุณุจู next release
    let nextRelease = null;
    if(!endAt || unlocked >= total){
      nextRelease = null;
    } else if(nowTs < endAt){
      nextRelease = endAt;
    } else if(nowTs < cliffEnd){
      nextRelease = cliffEnd;
    } else {
      // ุจุนุฏ ุงุฒ ฺฉููุ ููุจุช ูุงู ุจุนุฏ
      const vMonths = CONFIG.vesting.postCliffMonths;
      // ุชุนุฏุงุฏ ูุณุทโูุง ฺฏุฐุดุชู
      let played = Math.floor((unlocked - tge + 1e-9) / monthly);
      if(unlocked <= tge) played = 0;
      if(played < vMonths){
        nextRelease = new Date(cliffEnd);
        nextRelease.setMonth(nextRelease.getMonth() + played + 1);
      }
    }

    const claimed = Number(state.claimed?.[address]||0);
    const claimable = Math.max(0, unlocked - claimed);

    return { total, unlocked, claimable, nextRelease };
  }

  function renderHeader(){
    document.getElementById('projectName').textContent = CONFIG.projectName;
    document.getElementById('brand').textContent = CONFIG.projectName;
    document.getElementById('tokenTicker').textContent = `ููุงุฏ: ${CONFIG.symbol}`;
    document.getElementById('heroToken').textContent = CONFIG.symbol;
    document.getElementById('goalUSD').textContent = `${fmt(CONFIG.goalUSD)} ุฏูุงุฑ`;
    document.getElementById('goalUSD2').textContent = `${fmt(CONFIG.goalUSD)} ุฏูุงุฑ`;
    document.getElementById('goalTKN').textContent = `${fmt(CONFIG.totalPresaleTokens)} ${CONFIG.symbol}`;
    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('networkBadge').textContent = `ุดุจฺฉู: ${CONFIG.network.name}`;
  }

  function renderStages(){
    const rows = document.getElementById('stageRows');
    rows.innerHTML = '';
    let totalRaised = state.raisedUSD || 0;
    STAGES.forEach(s=>{
      const raisedStage = (s.sold * s.price) || 0;
      totalRaised += 0; // ูุญุงุณุจู ุจุงูุงุชุฑ ุงูุฌุงู ุดุฏู
      const left = Math.max(0, s.tokens - s.sold);
      const tr = document.createElement('tr');
      tr.className = 'border-b border-white/10';
      tr.innerHTML = `
        <td class="p-3">${s.id}</td>
        <td class="p-3">$${s.price.toFixed(2)}</td>
        <td class="p-3">${fmt(s.tokens)}</td>
        <td class="p-3">${fmt(Math.floor(s.sold))}</td>
        <td class="p-3">${fmt(Math.floor(left))}</td>
        <td class="p-3">$${fmt(Math.floor(raisedStage))}</td>
      `;
      rows.appendChild(tr);
    });

    // ฺฉุงุฑุช ูุถุนุช ุจุงูุง
    const idx = currentStageIndex();
    const active = STAGES[idx];
    document.getElementById('currentStageLabel').textContent = `ูุฑุญูู ${active.id}/${STAGES.length}`;
    document.getElementById('currentPrice').textContent = active.price.toFixed(2);
    const left = Math.max(0, active.tokens - active.sold);
    const sold = Math.min(active.tokens, active.sold);
    const pct = Math.min(100, Math.round((sold/active.tokens)*100));
    document.getElementById('stageProgress').style.width = pct + '%';
    document.getElementById('soldInStage').textContent = fmt(Math.floor(sold));
    document.getElementById('leftInStage').textContent = fmt(Math.floor(left));

    // ูพุดุฑูุช ฺฉู
    const raised = STAGES.reduce((sum,s)=> sum + s.sold*s.price, 0);
    const pctGoal = Math.min(100, (raised/CONFIG.goalUSD)*100);
    document.getElementById('raisedUSD').textContent = fmt(Math.floor(raised));
    document.getElementById('totalProgress').style.width = pctGoal + '%';
  }

  function renderUser(){
    const addr = user || 'demo';
    const v = calcUserVesting(addr);
    document.getElementById('youTotal').textContent = fmt(v.total.toFixed ? Number(v.total.toFixed(2)) : v.total);
    document.getElementById('youUnlocked').textContent = fmt(Number(v.unlocked.toFixed(2)));
    document.getElementById('youLocked').textContent = fmt(Number((v.total - v.unlocked).toFixed(2)));
    document.getElementById('youClaimable').textContent = fmt(Number(v.claimable.toFixed(2)));

    const btn = document.getElementById('btnClaim');
    btn.disabled = !(v.claimable > 0);

    const lbl = document.getElementById('nextReleaseLabel');
    const cd = document.getElementById('countdown');
    if(v.nextRelease){
      lbl.textContent = v.nextRelease.toLocaleDateString('fa-IR');
      const ms = v.nextRelease - now();
      if(ms > 0){
        const d = Math.floor(ms/86400000), h=Math.floor(ms%86400000/3600000), m=Math.floor(ms%3600000/60000);
        cd.textContent = `${d} ุฑูุฒุ ${h} ุณุงุนุชุ ${m} ุฏููู`; 
      } else cd.textContent = "โ";
    } else {
      lbl.textContent = 'โ';
      cd.textContent = 'โ';
    }
  }

  function renderTokenomics(){
    const list = document.getElementById('tokenomicsList');
    list.innerHTML = '';
    TOKENOMICS.forEach((t,i)=>{
      const el = document.createElement('div');
      el.className = 'p-4 rounded-xl bg-white/5 flex items-center justify-between';
      el.innerHTML = `<span>${t.label}</span><b>${t.value}%</b>`;
      list.appendChild(el);
    });

    const ctx = document.getElementById('pie');
    const data = TOKENOMICS.map(t=>t.value);
    const labels = TOKENOMICS.map(t=>t.label);
    new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data }] }, options:{ plugins:{ legend:{ position:'bottom' }}}});
  }

  // =====================
  // ๐๏ธ ุฑูุฏุงุฏูุง
  // =====================
  document.addEventListener('click', (e)=>{
    const el = e.target.closest('.pay');
    if(el){
      $$('.pay').forEach(x=>{ x.className = 'pay px-4 py-3 rounded-xl border border-white/15'; x.setAttribute('aria-pressed','false') });
      el.className = 'pay btn'; el.setAttribute('aria-pressed','true');
      payAsset = el.dataset.pay;
    }
  });

  document.getElementById('inpUsd').addEventListener('input', (e)=>{
    const usd = Number(e.target.value||0);
    const est = calcEstTokens(usd);
    document.getElementById('estTokens').textContent = fmt(est.toFixed(2));
  });

  document.getElementById('btnBuy').addEventListener('click', async()=>{
    const usd = Number(document.getElementById('inpUsd').value||0);
    if(!usd || usd < 1){ document.getElementById('buyMsg').textContent = 'ูุจูุบ ูุนุชุจุฑ ูุงุฑุฏ ฺฉูุฏ.'; return; }

    if(!CONFIG.addresses.PRESALE_CONTRACT){
      // ุญุงูุช ุฏูู: ููุท ูุญุงุณุจุงุช ู ุจูโุฑูุฒุฑุณุงู ุฌุฏูู
      const addr = user || 'demo';
      buySimulate(usd, addr);
      document.getElementById('buyMsg').textContent = `โ ุฎุฑุฏ ุดุจูโุณุงุฒ ุดุฏ. ูุจูุบ ${fmt(usd)} USD ุซุจุช ุดุฏ.`;
      renderStages(); renderUser();
      return;
    }

    // ุญุงูุช ูุงูุน (ูพุณ ุงุฒ ูพุฑ ฺฉุฑุฏู ุขุฏุฑุณโูุง ู ABI)
    try{
      if(!provider){ await connect(); }
      // TODO: 
      // 1) ุงฺฏุฑ payAsset==USDT: 
      //    - approve(USDT -> PRESALE_CONTRACT, usd * 10**decimals)
      //    - presaleContract.buyWithUSDT(usdAmount)
      // 2) ุงฺฏุฑ payAsset==BNB:
      //    - presaleContract.buyWithBNB({ value: ethers.utils.parseEther(bnbValue) })
      document.getElementById('buyMsg').textContent = 'โ๏ธ ุจุฑุง ูุนุงูโุณุงุฒ ุฎุฑุฏ ูุงูุนุ ุขุฏุฑุณ ูุฑุงุฑุฏุงุฏ/USDT ู ABI ุฑุง ุฏุฑ ฺฉุฏ ูุงุฑุฏ ฺฉูุฏ.';
    }catch(err){
      document.getElementById('buyMsg').textContent = 'ุฎุทุง ุฏุฑ ุชุฑุงฺฉูุด: ' + (err?.message||err);
    }
  });

  document.getElementById('btnClaim').addEventListener('click', async()=>{
    if(!CONFIG.addresses.PRESALE_CONTRACT){
      // ุฏูู: Claim = ุงูุฒูุฏู ุจู claimed ูุญู
      const addr = user || 'demo';
      const v = calcUserVesting(addr);
      if(v.claimable>0){
        state.claimed = state.claimed||{};
        state.claimed[addr] = (state.claimed[addr]||0) + v.claimable;
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        document.getElementById('claimMsg').textContent = `โ ${fmt(v.claimable.toFixed(2))} ุชูฺฉู Claim ุดุฏ (ุฏูู).`;
        renderUser();
      } else {
        document.getElementById('claimMsg').textContent = 'ูููุฒ ุชูฺฉู ูุงุจู Claim ูุณุช.';
      }
      return;
    }
    // ุญุงูุช ูุงูุน: ูุฑุงุฎูุงู ูุชุฏ claim() ูุฑุงุฑุฏุงุฏ
    document.getElementById('claimMsg').textContent = 'โ๏ธ ุจุฑุง Claim ูุงูุนุ ABI/Address ูุฑุงุฑุฏุงุฏ ุฑุง ุชูุธู ฺฉูุฏ.';
  });

  // ุฏฺฉูู ูพุงุงู ูพุดโูุฑูุด (ุจุฑุง ุฏูู)
  const endBtn = document.createElement('button');
  endBtn.className = 'mt-6 px-4 py-2 rounded-xl border border-white/15 text-sm';
  endBtn.textContent = 'ูพุงุงู ูพุดโูุฑูุด (ุฏูู) ู ุดุฑูุน TGE';
  endBtn.addEventListener('click', ()=>{
    state.presaleEndedAt = new Date().toISOString();
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    renderUser();
    alert('ูพุดโูุฑูุด ุฏุฑ ุญุงูุช ุฏูู ูพุงุงู ุงูุช. ฑตูช TGE ุขุฒุงุฏ ุดุฏ.');
  });
  document.querySelector('#buy .card').appendChild(endBtn);

  // ุงุชุตุงู ฺฉู ูพูู
  async function connect(){
    if(!window.ethereum){ alert('ฺฉู ูพูู Web3 ุฏุฑ ูุฑูุฑฺฏุฑ ุงูุช ูุดุฏ (MetaMask).'); return; }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    const accounts = await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    user = accounts[0];
    document.getElementById('btnConnect').textContent = userShort(user);

    // ุจุฑุฑุณ ุดุจฺฉู
    const net = await provider.getNetwork();
    if(Number(net.chainId) !== Number(CONFIG.network.chainId)){
      try{
        await provider.send('wallet_switchEthereumChain', [{ chainId: '0x'+CONFIG.network.chainId.toString(16) }]);
      }catch(e){ console.warn('switch failed', e); }
    }
    renderUser();
  }

  function userShort(a){ return a ? `${a.slice(0,6)}โฆ${a.slice(-4)}` : 'ูุชุตู ูุณุช'; }
  document.getElementById('btnConnect').addEventListener('click', connect);

  // ุฑูุฏุฑ ุงููู
  renderHeader();
  renderStages();
  renderUser();
  renderTokenomics();

  // ุชุงูุฑ ุดูุงุฑุด ุจุฑุง ุขูพุฏุช ฺฉูุชโุฏุงูู
  setInterval(()=> renderUser(), 30_000);

  </script>
</body>
</html>
