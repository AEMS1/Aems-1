<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مسابقه ماشین بلاکچینی</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            text-align: center;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 255, 0.5);
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00f7ff;
        }
        .section {
            background: rgba(30, 30, 60, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #4d4dff;
        }
        button {
            background: linear-gradient(to right, #4e54c8, #8f94fb);
            color: white;
            border: none;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 255, 0.6);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .wallet-info {
            font-size: 1.1rem;
            margin: 15px;
            padding: 10px;
            background: rgba(0, 0, 50, 0.6);
            border-radius: 10px;
            display: inline-block;
        }
        .error {
            color: #ff6b6b;
            background: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
        .network-info {
            background: rgba(0, 100, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚗 مسابقه ماشین بلاکچینی</h1>
        
        <div id="connectSection" class="section">
            <h2>اتصال کیف پول</h2>
            <button id="connectWallet">اتصال کیف پول</button>
            <div id="walletInfo" class="wallet-info hidden">
                <div>آدرس: <span id="walletAddress"></span></div>
                <div>موجودی: <span id="tokenBalance"></span> TOKEN</div>
                <div>شبکه: <span id="networkName"></span></div>
            </div>
            <div id="errorInfo" class="error hidden"></div>
            <div id="networkInfo" class="network-info hidden">
                <p>⚠️ لطفاً مطمئن شوید به شبکه <strong>Binance Smart Chain</strong> متصل هستید</p>
                <button id="switchNetwork">تغییر به شبکه Binance</button>
            </div>
        </div>
    </div>

    <script>
        // =============== تنظیمات ===============
        const BSC_MAINNET = {
            chainId: "0x38", // 56 in decimal
            chainName: "Binance Smart Chain",
            nativeCurrency: {
                name: "BNB",
                symbol: "BNB",
                decimals: 18
            },
            rpcUrls: ["https://bsc-dataseed.binance.org/"],
            blockExplorerUrls: ["https://bscscan.com"]
        };

        // =============== عناصر DOM ===============
        const connectWalletBtn = document.getElementById('connectWallet');
        const walletInfoDiv = document.getElementById('walletInfo');
        const walletAddressSpan = document.getElementById('walletAddress');
        const tokenBalanceSpan = document.getElementById('tokenBalance');
        const networkNameSpan = document.getElementById('networkName');
        const errorInfoDiv = document.getElementById('errorInfo');
        const networkInfoDiv = document.getElementById('networkInfo');
        const switchNetworkBtn = document.getElementById('switchNetwork');
        
        // =============== اتصال به کیف پول ===============
        async function connectWallet() {
            try {
                // پاک کردن خطاهای قبلی
                errorInfoDiv.classList.add('hidden');
                
                // بررسی وجود متامسک
                if (!window.ethereum) {
                    throw new Error("متامسک یافت نشد! لطفاً ابتدا متامسک را نصب کنید.");
                }
                
                // درخواست دسترسی به حساب‌ها
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                // تنظیم ارائه‌دهنده اترز
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();
                
                // نمایش اطلاعات شبکه
                networkNameSpan.textContent = network.name;
                
                // بررسی شبکه
                if (network.chainId !== 56) {
                    networkInfoDiv.classList.remove('hidden');
                    return;
                }
                
                // دریافت آدرس کیف پول
                const userAddress = accounts[0];
                walletAddressSpan.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                
                // دریافت موجودی توکن
                const tokenContract = new ethers.Contract(
                    "0x259115680169276d0e4286acba362460456697c5",
                    ['function balanceOf(address) view returns (uint256)'],
                    provider
                );
                
                const balance = await tokenContract.balanceOf(userAddress);
                tokenBalanceSpan.textContent = ethers.utils.formatUnits(balance, 18);
                
                // نمایش اطلاعات
                walletInfoDiv.classList.remove('hidden');
                connectWalletBtn.textContent = "اتصال مجدد کیف پول";
                
            } catch (error) {
                console.error("خطا در اتصال:", error);
                showError(error.message || "خطای ناشناخته در اتصال به کیف پول");
            }
        }
        
        // =============== تغییر شبکه ===============
        async function switchToBscNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [BSC_MAINNET]
                });
                
                // پس از تغییر شبکه، اتصال را مجدداً انجام دهید
                setTimeout(connectWallet, 1000);
                
            } catch (error) {
                console.error("خطا در تغییر شبکه:", error);
                showError("امکان تغییر شبکه وجود ندارد. لطفاً دستی به شبکه Binance تغییر دهید.");
            }
        }
        
        // =============== نمایش خطا ===============
        function showError(message) {
            errorInfoDiv.textContent = message;
            errorInfoDiv.classList.remove('hidden');
        }
        
        // =============== گوش دادن به تغییر حساب‌ها ===============
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    connectWallet();
                } else {
                    walletInfoDiv.classList.add('hidden');
                    connectWalletBtn.textContent = "اتصال کیف پول";
                }
            });
            
            window.ethereum.on('chainChanged', (chainId) => {
                // وقتی شبکه تغییر کرد، صفحه را رفرش کنید
                window.location.reload();
            });
        }
        
        // =============== رویدادهای دکمه ===============
        connectWalletBtn.addEventListener('click', connectWallet);
        if (switchNetworkBtn) {
            switchNetworkBtn.addEventListener('click', switchToBscNetwork);
        }
        
        // =============== بررسی اولیه اتصال ===============
        async function checkInitialConnection() {
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        }
        
        // اجرای بررسی اولیه هنگام بارگذاری صفحه
        window.addEventListener('load', checkInitialConnection);
    </script>
</body>
</html> 
